<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SENTRY COMMAND | AI ACTIVE</title>
    <style>
        :root {
            --bg-dark: #0f1115;
            --panel-bg: #161b22;
            --border: #30363d;
            --text-main: #c9d1d9;
            --gold: #f1e05a;
            --green: #2ea043;
            --red: #da3633;
            --blue: #58a6ff;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; height: 100vh; overflow: hidden; }
        
        /* LAYOUT GRID */
        .grid-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            height: 95vh;
        }
        
        /* PANELS */
        .panel { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; padding: 15px; display: flex; flex-direction: column; }
        .panel-header { font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        
        .scroll-area { overflow-y: auto; flex-grow: 1; background: #0d1117; border: 1px solid var(--border); border-radius: 4px; padding: 5px; }

        /* HARDWARE / MOUNT BUTTONS */
        .drive-item { 
            background: #21262d; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #30363d; 
            display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;
        }
        .btn-mount { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .mount-go { background: var(--blue); color: #fff; }
        .mount-done { background: var(--green); color: #fff; }

        /* BROWSER ITEMS */
        .file-item { padding: 4px 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .file-item:hover { background: #21262d; }
        .selected { background: #1f6feb !important; color: white; }
        
        /* LISTS (Gold/Target) */
        .list-item { padding: 5px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; font-size: 0.9em; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 10px; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; border-radius: 4px; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-target { background: var(--green); }
        .btn-exec { background: var(--red); font-size: 1.1em; padding: 15px; margin-top: 20px; }

        .status-bar { margin-top: 10px; text-align: center; color: #8b949e; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="grid-container">
    
    <div style="display:flex; flex-direction:column; gap:20px;">
        
        <div class="panel" style="flex-grow:0">
            <div class="panel-header">üîå 0. HARDWARE MOUNT</div>
            <div id="drive-list">Loading USBs...</div>
            <button onclick="refreshDrives()" style="background:#21262d; border:1px solid #30363d; color:#8b949e; width:100%; margin-top:5px; padding:5px; cursor:pointer">‚Üª Refresh</button>
        </div>

        <div class="panel" style="flex-grow:0">
            <div class="panel-header">‚ö° 1. CONNECT NETWORK</div>
            <input type="text" placeholder="//SERVER/Share" style="width:100%; margin-bottom:5px; background:#0d1117; border:1px solid #30363d; color:white; padding:5px;">
            <button class="btn" style="background:#21262d">Mount Network Drive</button>
        </div>

        <div class="panel" style="flex-grow:1">
            <div class="panel-header" style="color:var(--gold)">üõ°Ô∏è 3. GOLD (PROTECTED)</div>
            <div class="scroll-area" id="gold-list-area"></div>
            <button class="btn" style="background:#21262d" onclick="clearList('gold')">Clear List</button>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            üìÅ 2. SOURCE SELECTION
            <span id="current-path" style="font-weight:normal; font-size:0.8em; margin-left:auto; color:#8b949e">/</span>
        </div>
        
        <div class="file-item" onclick="goUp()" style="border-bottom:1px solid #30363d; margin-bottom:5px">‚¨ÜÔ∏è .. (Go Up)</div>
        
        <div class="scroll-area" id="file-browser"></div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-gold" onclick="addSelection('gold')">üõ°Ô∏è ADD TO GOLD</button>
            <button class="btn btn-target" onclick="addSelection('target')">üéØ ADD TO TARGET</button>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header" style="color:var(--green)">üéØ 4. TARGETS</div>
        <div class="scroll-area" id="target-list-area"></div>
        <button class="btn" style="background:#21262d" onclick="clearList('target')">Clear List</button>

        <div style="margin-top:20px; border-top:1px solid #30363d; padding-top:20px;">
            <div class="panel-header">‚ö° 5. EXECUTION</div>
            
            <label style="display:flex; align-items:center; gap:10px; cursor:pointer; background:#21262d; padding:10px; border-radius:4px;">
                <input type="checkbox" id="privacy-toggle" checked>
                <span>üëÅÔ∏è Enable AI Privacy Scan?</span>
            </label>

            <button class="btn btn-exec" onclick="startMission()">üöÄ START SCAN</button>
            <div class="status-bar" id="status-text">SYSTEM IDLE</div>
        </div>
    </div>

</div>

<script>
    // STATE
    let currentPath = '/media'; // Default to media so they see drives immediately
    let selectedFile = null;
    let goldPaths = [];
    let targetPaths = [];

    // --- 1. HARDWARE ---
    async function refreshDrives() {
        const div = document.getElementById('drive-list');
        div.innerHTML = 'Scanning...';
        try {
            const res = await fetch('/api/drives');
            const drives = await res.json();
            div.innerHTML = '';
            
            drives.forEach(d => {
                // Only show real disks
                if(d.device.startsWith('/dev/sd')) {
                    const btnClass = d.is_mounted ? 'mount-done' : 'mount-go';
                    const btnText = d.is_mounted ? 'UNMOUNT' : 'MOUNT';
                    const action = d.is_mounted ? 'false' : 'true';
                    
                    div.innerHTML += `
                        <div class="drive-item">
                            <div>
                                <div>${d.device} (${d.size})</div>
                                <div style="color:${d.health.includes('PASSED')?'var(--green)':'var(--red)'}">${d.health}</div>
                            </div>
                            <button class="btn-mount ${btnClass}" onclick="toggleMount('${d.device}', ${action})">${btnText}</button>
                        </div>
                    `;
                }
            });
            if(div.innerHTML === '') div.innerHTML = '<div style="color:#888; padding:10px">No USB Drives Found</div>';
        } catch(e) { div.innerHTML = 'Error loading drives'; }
    }

    async function toggleMount(dev, doMount) {
        const ep = doMount ? '/api/drives/mount' : '/api/drives/unmount';
        await fetch(ep, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({device_path: dev})
        });
        setTimeout(() => { refreshDrives(); loadBrowser('/media'); }, 1000);
    }

    // --- 2. BROWSER ---
    async function loadBrowser(path) {
        currentPath = path;
        document.getElementById('current-path').innerText = path;
        const container = document.getElementById('file-browser');
        container.innerHTML = 'Loading...';
        
        try {
            const res = await fetch(`/api/fs/list?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            container.innerHTML = '';
            
            data.entries.forEach(e => {
                const icon = e.type === 'dir' ? 'üìÅ' : 'üìÑ';
                const el = document.createElement('div');
                el.className = 'file-item';
                el.innerHTML = `<span>${icon}</span> ${e.name}`;
                
                el.onclick = () => {
                    if(e.type === 'dir') loadBrowser(e.path);
                    else {
                        selectedFile = e.path; // Select file
                        // Visual selection logic could go here
                    }
                };
                
                // RIGHT CLICK to select folder as target/gold without entering
                el.oncontextmenu = (ev) => {
                    ev.preventDefault();
                    selectedFile = e.path;
                    alert("Selected: " + e.path);
                };

                container.appendChild(el);
            });
        } catch(e) { container.innerHTML = 'Access Denied'; }
    }

    function goUp() {
        const parent = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/';
        loadBrowser(parent);
    }

    // --- 3. LIST MANAGEMENT ---
    function addSelection(type) {
        // If nothing clicked, use CURRENT FOLDER
        const pathToAdd = selectedFile || currentPath;
        
        if(type === 'gold') {
            if(!goldPaths.includes(pathToAdd)) goldPaths.push(pathToAdd);
            renderList('gold-list-area', goldPaths);
        } else {
            if(!targetPaths.includes(pathToAdd)) targetPaths.push(pathToAdd);
            renderList('target-list-area', targetPaths);
        }
        selectedFile = null; // Reset
    }

    function renderList(id, arr) {
        const div = document.getElementById(id);
        div.innerHTML = '';
        arr.forEach(p => {
            div.innerHTML += `<div class="list-item"><span>${p.split('/').pop()}</span> <span style="color:red; cursor:pointer" onclick="removeItem('${id}', '${p}')">X</span></div>`;
        });
    }

    // --- 4. EXECUTION ---
    async function startMission() {
        if(goldPaths.length === 0 || targetPaths.length === 0) { alert("Lists cannot be empty!"); return; }
        
        const res = await fetch('/api/scan', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                gold_paths: goldPaths,
                target_paths: targetPaths,
                enable_privacy: document.getElementById('privacy-toggle').checked
            })
        });
        const data = await res.json();
        document.getElementById('status-text').innerText = "MISSION RUNNING: " + data.mission_id;
    }

    // INIT
    refreshDrives();
    loadBrowser('/media'); // Start in media so they see USBs
    
    // Status Poll
    setInterval(async () => {
        const res = await fetch('/api/status');
        const d = await res.json();
        if(d.status !== 'IDLE') document.getElementById('status-text').innerText = `STATUS: ${d.status} | FILES: ${d.file_count}`;
    }, 2000);

</script>
</body>
</html>
