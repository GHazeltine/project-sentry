<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SENTRY COMMAND | TREE VIEW</title>
  <style>
    :root { --neon: #00ff41; --gold: #ffd700; --dark: #0d1117; --panel: #161b22; --danger: #ff3333; --highlight: #1f6feb; }
    body { background: var(--dark); color: #c9d1d9; font-family: 'Courier New', monospace; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* Layout */
    .grid { display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; height: 85vh; }
    .col { display: flex; flex-direction: column; gap: 15px; }
    
    .card { background: var(--panel); border: 1px solid #30363d; padding: 15px; border-radius: 6px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    h3 { margin: 0 0 10px 0; border-bottom: 1px solid #30363d; padding-bottom: 5px; font-size: 1.1em; }
    
    /* Inputs */
    input, select { background: #0b0f14; color: white; border: 1px solid #30363d; padding: 8px; width: 100%; box-sizing: border-box; }
    button { background: #21262d; color: white; border: 1px solid #30363d; padding: 10px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
    button:hover { background: #30363d; }
    
    .btn-gold { background: var(--gold); color: black; border: none; }
    .btn-neon { background: var(--neon); color: black; border: none; }
    .btn-danger { background: var(--danger); color: white; border: none; }

    /* TREE VIEW CSS */
    .tree-container { 
      flex-grow: 1; 
      background: #0b0f14; 
      border: 1px solid #30363d; 
      overflow-y: auto; 
      padding: 10px; 
      font-size: 0.9em;
    }
    .tree-item { margin-left: 15px; display: flex; flex-direction: column; }
    .tree-row { display: flex; align-items: center; cursor: pointer; padding: 2px 0; }
    .tree-row:hover { background: #161b22; }
    .tree-row.selected { background: var(--highlight); color: white; }
    
    .caret { 
      width: 20px; text-align: center; cursor: pointer; user-select: none; color: var(--neon); font-weight: bold; 
    }
    .caret:hover { color: white; }
    .icon { margin-right: 5px; }
    .label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hidden { display: none; }

    /* Lists */
    .list-box { background: black; border: 1px solid #30363d; flex-grow: 1; overflow-y: auto; padding: 5px; }
    .list-item { padding: 5px; border-bottom: 1px solid #222; font-size: 0.85em; display: flex; justify-content: space-between; }
    .remove-x { color: red; cursor: pointer; font-weight: bold; margin-left: 5px; }
  </style>
</head>
<body>
<div class="container">
  
  <div class="grid">
    
    <div class="col">
      <div class="card" style="flex-grow: 0;">
        <h3>üîå 1. CONNECT</h3>
        <input id="netPath" placeholder="//SERVER/Share" style="margin-bottom:5px;">
        <div style="display:flex; gap:5px;">
          <input id="netUser" placeholder="User" style="width:50%;">
          <input id="netPass" type="password" placeholder="Pass" style="width:50%;">
        </div>
        <button onclick="mountNetwork()" style="margin-top:5px;">Mount Network Drive</button>
      </div>

      <div class="card">
        <h3 style="color: var(--gold)">üõ°Ô∏è 3. GOLD (PROTECTED)</h3>
        <div class="list-box" id="goldList"></div>
        <div style="font-size:0.8em; color:gray; margin-top:5px;">Files here will NEVER be deleted.</div>
        <button onclick="clearList('gold')">Clear List</button>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3>üìÇ 2. SOURCE SELECTION</h3>
        
        <select id="driveJump" onchange="initTree(this.value)">
          <option value="NONE">-- JUMP TO PARENT --</option>
          <option value="/media">Local USBs (/media)</option>
          <option value="/run/media">Linux USBs (/run/media)</option>
          <option value="/mnt/sentry">Network Drives (/mnt/sentry)</option>
          <option value="/">System Root (/)</option>
        </select>
        
        <div style="display:flex; justify-content:space-between; margin:5px 0;">
          <span id="currentRoot" style="color:gray; font-size:0.8em;">Select a root...</span>
          <button onclick="refreshTree()" style="padding:2px 8px; font-size:0.8em;">‚Üª Refresh</button>
        </div>

        <div class="tree-container" id="treeRoot">
          <div style="padding:20px; text-align:center; color:gray;">
            Select a "Jump To" location above<br>to see your drives.
          </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <button class="btn-gold" onclick="addSelection('gold')">üõ°Ô∏è ADD DRIVE/FOLDER</button>
          <button class="btn-neon" onclick="addSelection('target')">üéØ ADD DRIVE/FOLDER</button>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3 style="color: var(--neon)">üéØ 4. TARGETS (CLEAN)</h3>
        <div class="list-box" id="targetList"></div>
        <div style="font-size:0.8em; color:gray; margin-top:5px;">Duplicates found here will be deleted.</div>
        <button onclick="clearList('target')">Clear List</button>
      </div>

      <div class="card" style="flex-grow: 0;">
        <h3>‚ö° 5. EXECUTION</h3>
        <div id="statusBox" style="text-align:center; margin-bottom:10px; font-weight:bold;">IDLE</div>
        <button class="btn-neon" onclick="startScan()">üîç START SCAN</button>
        <button onclick="analyze()" id="btnAnalyze" disabled>üíÄ ANALYZE</button>
        <button class="btn-danger" onclick="clean()" id="btnClean" disabled>‚ö†Ô∏è EXECUTE REAPER</button>
      </div>
    </div>

  </div>
</div>

<script>
  // --- STATE ---
  let selectedPath = null; // Currently highlighted path in Tree
  let goldPaths = new Set();
  let targetPaths = new Set();
  let currentRoot = "";

  // --- API ---
  async function api(url, method='GET', body=null) {
    const opts = { method, headers: {'Content-Type': 'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(url, opts);
    return r.json();
  }

  // --- TREE VIEW LOGIC ---
  async function initTree(rootPath) {
    if (rootPath === "NONE") return;
    currentRoot = rootPath;
    document.getElementById('currentRoot').innerText = "Viewing: " + rootPath;
    const container = document.getElementById('treeRoot');
    container.innerHTML = "Loading...";
    
    // Load top level
    await loadFolder(rootPath, container);
  }

  function refreshTree() { initTree(currentRoot); }

  async function loadFolder(path, containerElement) {
    const res = await api(`/api/fs/list?path=${encodeURIComponent(path)}`);
    
    containerElement.innerHTML = ''; // Clear "Loading..."

    if (res.error) {
      containerElement.innerHTML = `<div style="color:red; padding:5px;">Error: ${res.error}</div>`;
      return;
    }

    if (!res.entries || res.entries.length === 0) {
      containerElement.innerHTML = `<div style="color:gray; font-style:italic; padding-left:20px;">(Empty)</div>`;
      return;
    }

    res.entries.forEach(entry => {
      // Build Tree Node
      const node = document.createElement('div');
      node.className = 'tree-item';
      
      const row = document.createElement('div');
      row.className = 'tree-row';
      row.onclick = (e) => {
        // Prevent caret click from triggering select
        if(e.target.className.includes('caret')) return;
        selectNode(row, entry.path);
      };

      // Caret (Expand/Collapse)
      const caret = document.createElement('span');
      caret.className = 'caret';
      if (entry.type === 'dir') {
        caret.innerText = '‚ñ∂';
        caret.onclick = () => toggleFolder(caret, childrenContainer, entry.path);
      } else {
        caret.innerText = '‚Ä¢'; // File dot
        caret.style.color = 'gray';
      }

      // Icon
      const icon = document.createElement('span');
      icon.className = 'icon';
      icon.innerText = entry.type === 'dir' ? 'üìÅ' : 'üìÑ';

      // Label
      const label = document.createElement('span');
      label.className = 'label';
      label.innerText = entry.name;

      row.appendChild(caret);
      row.appendChild(icon);
      row.appendChild(label);
      
      node.appendChild(row);

      // Children Container (Hidden by default)
      const childrenContainer = document.createElement('div');
      childrenContainer.className = 'hidden';
      node.appendChild(childrenContainer);

      containerElement.appendChild(node);
    });
  }

  async function toggleFolder(caret, container, path) {
    // If hidden, show it
    if (container.classList.contains('hidden')) {
      caret.innerText = '‚ñº';
      container.classList.remove('hidden');
      
      // Load content if not already loaded
      if (container.innerHTML === '') {
        container.innerHTML = '<div style="padding-left:20px; color:gray;">Loading...</div>';
        await loadFolder(path, container);
      }
    } else {
      // Hide it
      caret.innerText = '‚ñ∂';
      container.classList.add('hidden');
    }
  }

  function selectNode(rowElement, path) {
    // Remove previous selection highlight
    document.querySelectorAll('.tree-row.selected').forEach(el => el.classList.remove('selected'));
    // Add new highlight
    rowElement.classList.add('selected');
    selectedPath = path;
  }

  // --- SELECTION LOGIC ---
  function addSelection(type) {
    if (!selectedPath) return alert("Please click a folder in the tree first.");
    
    if (type === 'gold') goldPaths.add(selectedPath);
    else targetPaths.add(selectedPath);
    
    renderLists();
  }

  function renderLists() {
    const render = (set, elId, type) => {
      const el = document.getElementById(elId);
      el.innerHTML = '';
      set.forEach(p => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `<span>${p}</span> <span class="remove-x" onclick="removePath('${type}', '${p.replace(/\\/g, '\\\\')}')">X</span>`;
        el.appendChild(div);
      });
    };
    render(goldPaths, 'goldList', 'gold');
    render(targetPaths, 'targetList', 'target');
  }

  function removePath(type, val) {
    if (type === 'gold') goldPaths.delete(val);
    else targetPaths.delete(val);
    renderLists();
  }

  function clearList(type) {
    if (type === 'gold') goldPaths.clear();
    else targetPaths.clear();
    renderLists();
  }

  // --- OPERATIONS (Mount/Scan/Clean) ---
  async function mountNetwork() {
    const p = document.getElementById('netPath').value;
    const u = document.getElementById('netUser').value;
    const pass = document.getElementById('netPass').value;
    const res = await api('/api/mount', 'POST', { remote_path:p, username:u, password:pass });
    alert(res.message || "Done");
    // If currently viewing network, refresh
    if (currentRoot === '/mnt/sentry') refreshTree();
  }

  async function startScan() {
    if (goldPaths.size === 0 || targetPaths.size === 0) return alert("Select at least one GOLD and one TARGET.");
    document.getElementById('statusBox').innerText = "STARTING...";
    
    const res = await api('/api/scan', 'POST', { 
      gold_paths: Array.from(goldPaths), 
      target_paths: Array.from(targetPaths) 
    });
    
    if (res.error) return alert(res.error);

    const timer = setInterval(async () => {
      const s = await api('/api/status');
      document.getElementById('statusBox').innerText = s.status + " | Files: " + s.file_count;
      if (s.status === 'COMPLETE') {
        clearInterval(timer);
        document.getElementById('btnAnalyze').disabled = false;
      }
    }, 1000);
  }

  async function analyze() {
    const res = await api('/api/analyze');
    alert(`Found ${res.count} duplicates (${res.size_gb} GB).`);
    if (res.count > 0) document.getElementById('btnClean').disabled = false;
  }

  async function clean() {
    if (!confirm("WARNING: This will delete duplicate files from TARGET folders. Confirm?")) return;
    const res = await api('/api/clean', 'POST', {});
    alert(`Deleted: ${res.deleted} | Errors: ${res.errors}`);
  }
</script>
</body>
</html>
