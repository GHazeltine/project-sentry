<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SENTRY COMMAND | MULTI-SOURCE</title>
  <style>
    :root { --neon: #00ff41; --gold: #ffd700; --dark: #0d1117; --panel: #161b22; --danger: #ff3333; }
    body { background: var(--dark); color: #c9d1d9; font-family: 'Courier New', monospace; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    /* 3-Column Grid */
    .grid { display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; height: 85vh; }
    .col { display: flex; flex-direction: column; gap: 15px; }
    
    .card { background: var(--panel); border: 1px solid #30363d; padding: 15px; border-radius: 6px; flex-grow: 1; display: flex; flex-direction: column; }
    h3 { margin: 0 0 10px 0; border-bottom: 1px solid #30363d; padding-bottom: 5px; font-size: 1.1em; }
    
    /* Inputs & Selects */
    select { background: #0b0f14; color: white; border: 1px solid #30363d; padding: 8px; width: 100%; }
    #fsBrowser { flex-grow: 1; font-family: monospace; }
    
    button { background: #21262d; color: white; border: 1px solid #30363d; padding: 10px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
    button:hover { background: #30363d; }
    
    .btn-gold { background: var(--gold); color: black; border: none; }
    .btn-neon { background: var(--neon); color: black; border: none; }
    .btn-danger { background: var(--danger); color: white; border: none; }
    
    .list-box { background: black; border: 1px solid #30363d; flex-grow: 1; overflow-y: auto; padding: 5px; }
    .list-item { padding: 5px; border-bottom: 1px solid #222; font-size: 0.85em; display: flex; justify-content: space-between; }
    .remove-x { color: red; cursor: pointer; font-weight: bold; margin-left: 5px; }
  </style>
</head>
<body>
<div class="container">
  
  <div class="grid">
    
    <div class="col">
      <div class="card" style="flex-grow: 0;">
        <h3>üîå 1. NETWORK CONNECT</h3>
        <input id="netPath" placeholder="//SERVER/Share" style="width:94%; margin-bottom:5px; padding:5px; background:#0b0f14; color:white; border:1px solid #333;">
        <div style="display:flex; gap:5px;">
          <input id="netUser" placeholder="User" style="width:50%; padding:5px; background:#0b0f14; color:white; border:1px solid #333;">
          <input id="netPass" type="password" placeholder="Pass" style="width:50%; padding:5px; background:#0b0f14; color:white; border:1px solid #333;">
        </div>
        <button onclick="mountNetwork()" style="margin-top:5px;">Connect Drive</button>
      </div>

      <div class="card">
        <h3 style="color: var(--gold)">üõ°Ô∏è 3. GOLD (PROTECTED)</h3>
        <div class="list-box" id="goldList"></div>
        <div style="font-size:0.8em; color:gray; margin-top:5px;">Files here are SAFE.</div>
        <button onclick="clearList('gold')">Clear List</button>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3>üìÇ 2. BROWSE & SELECT</h3>
        
        <select id="driveJump" onchange="jumpTo(this.value)">
          <option value="ROOT">-- JUMP TO DRIVE SOURCE --</option>
          <option value="/media">Local USB Drives (/media)</option>
          <option value="/mnt/sentry">Network Mounts (/mnt/sentry)</option>
          <option value="/">Internal Root (/)</option>
        </select>

        <div id="currentPath" style="padding: 5px; color: var(--neon); font-size: 0.9em;">ROOT</div>
        
        <select id="fsBrowser" size="20" ondblclick="fsEnter()"></select>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button onclick="fsUp()" style="flex:1;">‚¨Ü UP</button>
          <button onclick="fsEnter()" style="flex:1;">‚û° ENTER</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <button class="btn-gold" onclick="addPath('gold')">üõ°Ô∏è ADD TO GOLD</button>
          <button class="btn-neon" onclick="addPath('target')">üéØ ADD TO TARGET</button>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3 style="color: var(--neon)">üéØ 4. TARGETS (CLEAN)</h3>
        <div class="list-box" id="targetList"></div>
        <div style="font-size:0.8em; color:gray; margin-top:5px;">Duplicates here get DELETED.</div>
        <button onclick="clearList('target')">Clear List</button>
      </div>

      <div class="card" style="flex-grow: 0;">
        <h3>‚ö° 5. EXECUTION</h3>
        <div id="statusBox" style="text-align:center; margin-bottom:10px; font-weight:bold;">IDLE</div>
        <button class="btn-neon" onclick="startScan()">üîç START SCAN</button>
        <button onclick="analyze()" id="btnAnalyze" disabled>üíÄ ANALYZE</button>
        <button class="btn-danger" onclick="clean()" id="btnClean" disabled>‚ö†Ô∏è EXECUTE REAPER</button>
      </div>
    </div>

  </div>
</div>

<script>
  let currentPath = "ROOT";
  let goldPaths = new Set();
  let targetPaths = new Set();
  let timer = null;

  async function api(url, method='GET', body=null) {
    const opts = { method, headers: {'Content-Type': 'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    return (await fetch(url, opts)).json();
  }

  async function fsLoad(path) {
    const res = await api(`/api/fs/list?path=${encodeURIComponent(path)}`);
    if (res.error) return alert(res.error);
    
    currentPath = res.path;
    document.getElementById('currentPath').innerText = currentPath;
    const browser = document.getElementById('fsBrowser');
    browser.innerHTML = '';
    
    res.entries.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e.path;
      opt.text = (e.type === 'dir' ? "üìÅ " : "üìÑ ") + e.name;
      browser.add(opt);
    });
  }

  function jumpTo(val) { if(val !== "ROOT") fsLoad(val); }
  function fsUp() { 
    if(currentPath === "ROOT" || currentPath === "/") return fsLoad("ROOT");
    const parts = currentPath.split('/'); parts.pop();
    fsLoad(parts.join('/') || "/");
  }
  function fsEnter() {
    const sel = document.getElementById('fsBrowser').value;
    if(sel) fsLoad(sel);
  }

  function addPath(type) {
    const val = document.getElementById('fsBrowser').value || currentPath;
    if (val === "ROOT") return alert("Select a folder first.");
    if (type === 'gold') goldPaths.add(val);
    else targetPaths.add(val);
    renderLists();
  }

  function removePath(type, val) {
    if (type === 'gold') goldPaths.delete(val);
    else targetPaths.delete(val);
    renderLists();
  }

  function clearList(type) {
    if (type === 'gold') goldPaths.clear();
    else targetPaths.clear();
    renderLists();
  }

  function renderLists() {
    const render = (set, elId, type) => {
      const el = document.getElementById(elId);
      el.innerHTML = '';
      set.forEach(p => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `<span>${p}</span> <span class="remove-x" onclick="removePath('${type}', '${p.replace(/\\/g, '\\\\')}')">X</span>`;
        el.appendChild(div);
      });
    };
    render(goldPaths, 'goldList', 'gold');
    render(targetPaths, 'targetList', 'target');
  }

  async function mountNetwork() {
    const p = document.getElementById('netPath').value;
    const u = document.getElementById('netUser').value;
    const pass = document.getElementById('netPass').value;
    const res = await api('/api/mount', 'POST', { remote_path:p, username:u, password:pass });
    alert(res.message || "Done");
    fsLoad('/mnt/sentry');
  }

  async function startScan() {
    if (goldPaths.size === 0 || targetPaths.size === 0) return alert("Select at least one GOLD and one TARGET path.");
    document.getElementById('statusBox').innerText = "STARTING...";
    const res = await api('/api/scan', 'POST', { 
      gold_paths: Array.from(goldPaths), 
      target_paths: Array.from(targetPaths) 
    });
    if (res.error) return alert(res.error);
    timer = setInterval(async () => {
      const s = await api('/api/status');
      document.getElementById('statusBox').innerText = s.status + " | Files: " + s.file_count;
      if (s.status === 'COMPLETE') {
        clearInterval(timer);
        document.getElementById('btnAnalyze').disabled = false;
      }
    }, 1000);
  }

  async function analyze() {
    const res = await api('/api/analyze');
    alert(`Found ${res.count} duplicates to delete (${res.size_gb} GB).`);
    if (res.count > 0) document.getElementById('btnClean').disabled = false;
  }

  async function clean() {
    if (!confirm("WARNING: Files in TARGET folders will be deleted if duplicates exist in GOLD. Confirm?")) return;
    const res = await api('/api/clean', 'POST', {});
    alert(`Deleted: ${res.deleted} | Errors: ${res.errors}`);
  }

  fsLoad("ROOT");
</script>
</body>
</html>
