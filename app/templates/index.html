<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Silicon | Sentry</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .title { font-size: 1.5rem; font-weight: bold; color: #4caf50; }
        .status { background: #333; padding: 5px 10px; border-radius: 4px; }

        /* SECTIONS */
        .section {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .section-title {
            color: #90caf9;
            margin-top: 0;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* HARDWARE BAR (New) */
        .hardware-bar {
            background: #2c2c2c;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .drive-tag {
            display: inline-flex;
            align-items: center;
            background: #000;
            padding: 5px 10px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .btn-mount {
            background: #2196f3;
            color: white;
            border: none;
            padding: 4px 8px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 2px;
            font-size: 0.8rem;
        }
        .btn-mount.mounted { background: #4caf50; }

        /* FILE BROWSER */
        .browser {
            height: 200px;
            overflow-y: auto;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
        }
        .file-item {
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .file-item:hover { background: #333; }
        .selected { background: #1b5e20 !important; }
        .icon { margin-right: 10px; }

        /* CONTROLS */
        .controls { display: flex; align-items: center; gap: 20px; margin-top: 20px; }
        .btn-main {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        .btn-main:hover { background: #b71c1c; }

    </style>
</head>
<body>

    <div class="header">
        <div class="title">SENTRY COMMAND v3.0</div>
        <div class="status" id="system-status">STATUS: CHECKING...</div>
    </div>

    <div class="section">
        <h3 class="section-title">1. MASTER SOURCE (Gold)</h3>
        <div class="browser" id="gold-browser">Loading...</div>
        <div id="gold-path" style="margin-top:5px; color:#666; font-size:0.8rem">No selection</div>
    </div>

    <div class="section">
        <h3 class="section-title">2. TARGET DRIVE (Client)</h3>
        
        <div class="hardware-bar" id="hardware-list">
            Scanning USB Ports...
        </div>

        <div class="browser" id="target-browser">Loading...</div>
        <div id="target-path" style="margin-top:5px; color:#666; font-size:0.8rem">No selection</div>
    </div>

    <div class="section">
        <h3 class="section-title">3. MISSION CONTROL</h3>
        <div class="controls">
            <label style="display:flex; align-items:center; cursor:pointer">
                <input type="checkbox" id="privacy-toggle" style="width:20px; height:20px; margin-right:10px">
                <div>
                    <strong>Enable AI Privacy Scan</strong><br>
                    <span style="font-size:0.8rem; color:#888">Detect & Quarantine Sensitive Images</span>
                </div>
            </label>
        </div>
        <br>
        <button class="btn-main" onclick="startScan()">INITIATE SCAN</button>
    </div>

    <script>
        // STATE
        let selectedGold = null;
        let selectedTarget = null;

        // INIT
        window.onload = function() {
            refreshDrives();
            loadBrowser('/host_fs/home/greg', 'gold-browser', true);
            loadBrowser('/media', 'target-browser', false);
            updateStatus();
        };

        // --- 1. HARDWARE MANAGER ---
        async function refreshDrives() {
            const container = document.getElementById('hardware-list');
            try {
                const res = await fetch('/api/drives');
                const drives = await res.json();
                
                container.innerHTML = '<div style="font-size:0.8rem; margin-bottom:5px; color:#888">CONNECTED DRIVES:</div>';
                
                if(drives.length === 0) {
                    container.innerHTML += '<div>No USB drives detected.</div>';
                    return;
                }

                drives.forEach(drive => {
                    const btnClass = drive.is_mounted ? 'btn-mount mounted' : 'btn-mount';
                    const btnText = drive.is_mounted ? 'UNMOUNT' : 'MOUNT';
                    const action = drive.is_mounted ? 'false' : 'true';
                    
                    // Only show /dev/sdX devices (ignore internal loops/ram)
                    if(drive.device.startsWith('/dev/sd')) {
                        const html = `
                            <div class="drive-tag">
                                <span>${drive.name || drive.device} (${drive.size})</span>
                                <span style="font-size:0.7rem; color:${drive.health.includes('PASSED')?'#4caf50':'#ff9800'}; margin-left:8px">${drive.health}</span>
                                <button class="btn-mount ${drive.is_mounted ? 'mounted' : ''}" 
                                    onclick="toggleMount('${drive.device}', ${!drive.is_mounted})">
                                    ${drive.is_mounted ? 'UNMOUNT' : 'MOUNT'}
                                </button>
                            </div>
                        `;
                        container.innerHTML += html;
                    }
                });
            } catch(e) {
                container.innerHTML = "Error loading drives.";
            }
        }

        async function toggleMount(device, doMount) {
            const endpoint = doMount ? '/api/drives/mount' : '/api/drives/unmount';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ device_path: device })
            });
            const data = await res.json();
            
            if(data.error) {
                alert("Error: " + data.error);
            } else {
                // If mounted success, refresh drives AND refresh the target browser
                refreshDrives();
                setTimeout(() => loadBrowser('/media', 'target-browser', false), 500);
            }
        }

        // --- 2. FILE BROWSER ---
        async function loadBrowser(path, elementId, isGold) {
            const container = document.getElementById(elementId);
            container.innerHTML = "Loading...";
            
            try {
                const res = await fetch(`/api/fs/list?path=${encodeURIComponent(path)}`);
                const data = await res.json();
                
                if(data.error) {
                    container.innerHTML = `<div style="color:red">Error: ${data.error}</div>`;
                    if(!isGold) container.innerHTML += `<div style="font-size:0.8rem; color:#888; margin-top:5px">Tip: Mount the drive above first!</div>`;
                    return;
                }

                container.innerHTML = '';

                // Parent Dir
                if(path !== '/' && path !== '/host_fs') {
                    const parent = path.substring(0, path.lastIndexOf('/')) || '/';
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = '<span class="icon">‚¨ÜÔ∏è</span> .. (Go Up)';
                    div.onclick = () => loadBrowser(parent, elementId, isGold);
                    container.appendChild(div);
                }

                data.entries.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    if(isGold && selectedGold === entry.path) div.classList.add('selected');
                    if(!isGold && selectedTarget === entry.path) div.classList.add('selected');

                    const icon = entry.type === 'dir' ? 'üìÅ' : 'üìÑ';
                    div.innerHTML = `<span class="icon">${icon}</span> ${entry.name}`;
                    
                    // Click Logic
                    div.onclick = (e) => {
                        e.stopPropagation();
                        if(entry.type === 'dir') {
                            // Single click to navigate
                            loadBrowser(entry.path, elementId, isGold);
                        }
                    };

                    // Select Button for Dirs
                    if(entry.type === 'dir') {
                        const selBtn = document.createElement('span');
                        selBtn.innerText = " [SELECT]";
                        selBtn.style.color = "#4caf50";
                        selBtn.style.fontWeight = "bold";
                        selBtn.style.marginLeft = "auto";
                        selBtn.onclick = (e) => {
                            e.stopPropagation();
                            if(isGold) {
                                selectedGold = entry.path;
                                document.getElementById('gold-path').innerText = entry.path;
                            } else {
                                selectedTarget = entry.path;
                                document.getElementById('target-path').innerText = entry.path;
                            }
                            loadBrowser(path, elementId, isGold); // Re-render to show selection
                        };
                        div.appendChild(selBtn);
                    }
                    
                    container.appendChild(div);
                });

            } catch(e) {
                container.innerHTML = "Error loading files.";
            }
        }

        // --- 3. EXECUTE ---
        async function startScan() {
            if(!selectedGold || !selectedTarget) {
                alert("Please select both a Master Source and a Target Destination.");
                return;
            }

            const payload = {
                gold_paths: [selectedGold],
                target_paths: [selectedTarget],
                enable_privacy: document.getElementById('privacy-toggle').checked
            };

            const res = await fetch('/api/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            alert("Scan Started! ID: " + data.mission_id);
            updateStatus();
        }

        async function updateStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('system-status').innerText = `STATUS: ${data.status} | FILES: ${data.file_count}`;
            setTimeout(updateStatus, 3000);
        }
    </script>
</body>
</html>
