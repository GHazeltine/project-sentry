<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SENTRY COMMAND | TREE VIEW</title>
  <style>
    :root { --neon: #00ff41; --gold: #ffd700; --dark: #0d1117; --panel: #161b22; --danger: #ff3333; --highlight: #1f6feb; }
    body { background: var(--dark); color: #c9d1d9; font-family: 'Courier New', monospace; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    
    .grid { display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; height: 85vh; }
    .col { display: flex; flex-direction: column; gap: 15px; }
    .card { background: var(--panel); border: 1px solid #30363d; padding: 15px; border-radius: 6px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    h3 { margin: 0 0 10px 0; border-bottom: 1px solid #30363d; padding-bottom: 5px; font-size: 1.1em; }
    
    input, select { background: #0b0f14; color: white; border: 1px solid #30363d; padding: 8px; width: 100%; box-sizing: border-box; }
    button { background: #21262d; color: white; border: 1px solid #30363d; padding: 10px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
    button:hover { background: #30363d; }
    .btn-gold { background: var(--gold); color: black; border: none; }
    .btn-neon { background: var(--neon); color: black; border: none; }
    .btn-danger { background: var(--danger); color: white; border: none; }

    .tree-container { flex-grow: 1; background: #0b0f14; border: 1px solid #30363d; overflow-y: auto; padding: 10px; font-size: 0.9em; }
    .tree-row { display: flex; align-items: center; cursor: pointer; padding: 2px 0; }
    .tree-row:hover { background: #161b22; }
    .tree-row.selected { background: var(--highlight); color: white; }
    .caret { width: 20px; text-align: center; cursor: pointer; color: var(--neon); font-weight: bold; }
    .hidden { display: none; }
    
    .list-box { background: black; border: 1px solid #30363d; flex-grow: 1; overflow-y: auto; padding: 5px; }
    .list-item { padding: 5px; border-bottom: 1px solid #222; font-size: 0.85em; display: flex; justify-content: space-between; }
    .remove-x { color: red; cursor: pointer; font-weight: bold; margin-left: 5px; }
  </style>
</head>
<body>
<div class="container">
  <div class="grid">
    
    <div class="col">
      <div class="card" style="flex-grow: 0;">
        <h3>üîå 1. CONNECT</h3>
        <input id="netPath" placeholder="//SERVER/Share" style="margin-bottom:5px;">
        <div style="display:flex; gap:5px;">
          <input id="netUser" placeholder="User" style="width:50%;">
          <input id="netPass" type="password" placeholder="Pass" style="width:50%;">
        </div>
        <button onclick="mountNetwork()" style="margin-top:5px;">Mount Network Drive</button>
      </div>
      <div class="card">
        <h3 style="color: var(--gold)">üõ°Ô∏è 3. GOLD (PROTECTED)</h3>
        <div class="list-box" id="goldList"></div>
        <button onclick="clearList('gold')">Clear List</button>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3>üìÇ 2. SOURCE SELECTION</h3>
        
        <select id="driveJump" onchange="initTree(this.value)">
          <option value="NONE">-- LOADING HARDWARE... --</option>
        </select>
        
        <div style="display:flex; justify-content:space-between; margin:5px 0;">
          <span id="currentRoot" style="color:gray; font-size:0.8em;">Select a drive...</span>
          <button onclick="refreshTree()" style="padding:2px 8px;">‚Üª</button>
        </div>

        <div class="tree-container" id="treeRoot">
          <div style="padding:20px; text-align:center; color:gray;">Select a Drive above.</div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <button class="btn-gold" onclick="addSelection('gold')">üõ°Ô∏è ADD TO GOLD</button>
          <button class="btn-neon" onclick="addSelection('target')">üéØ ADD TO TARGET</button>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3 style="color: var(--neon)">üéØ 4. TARGETS (TO BE CLEANED)</h3>
        <div class="list-box" id="targetList"></div>
        <div style="font-size:0.8em; color:gray; margin-top:5px;">Duplicates here will be deleted.</div>
        <button onclick="clearList('target')">Clear List</button>
      </div>

      <div class="card" style="flex-grow: 0;">
        <h3>‚ö° 5. EXECUTION</h3>
        <div id="statusBox" style="text-align:center; margin-bottom:10px; font-weight:bold;">IDLE</div>
        <button class="btn-neon" onclick="startScan()">üîç START SCAN</button>
        <button onclick="analyze()" id="btnAnalyze" disabled>üíÄ ANALYZE</button>
        <button class="btn-danger" onclick="clean()" id="btnClean" disabled>‚ö†Ô∏è EXECUTE REAPER</button>
      </div>
    </div>

  </div>
</div>

<script>
  let selectedPath = null;
  let goldPaths = new Set();
  let targetPaths = new Set();
  let currentRoot = "";

  async function api(url, method='GET', body=null) {
    const opts = { method, headers: {'Content-Type': 'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    const r = await fetch(url, opts);
    return r.json();
  }

  // --- HARDWARE ---
  async function loadDrives() {
    const select = document.getElementById('driveJump');
    select.innerHTML = '<option value="NONE">-- SELECT HARDWARE --</option>';
    
    // Special Roots
    const specials = [
      { name: "üíª HOST COMPUTER (OS Drive)", path: "/host_fs" },
      { name: "üîå USB DRIVES (/media)", path: "/media" },
      { name: "üåê NETWORK MOUNTS", path: "/mnt/sentry" }
    ];
    specials.forEach(d => select.add(new Option(d.name, d.path)));

    // Real Hardware
    try {
      const drives = await api('/api/drives');
      if (Array.isArray(drives)) {
        select.add(new Option("--- PHYSICAL DRIVES ---", "NONE", true, true));
        drives.forEach(d => {
            if (d.mountpoint) {
                // Map host mountpoints to container path
                const path = d.mountpoint === "/" ? "/host_fs" : `/host_fs${d.mountpoint}`;
                select.add(new Option(`üíæ ${d.label || d.name} (${d.size})`, path));
            } else {
                select.add(new Option(`‚ö†Ô∏è ${d.label || d.name} (Unmounted)`, "NONE", true, true));
            }
        });
      }
    } catch (e) { console.error("Drive detect fail", e); }
  }

  // --- TREE VIEW (FIXED) ---
  async function initTree(rootPath) {
    if (rootPath === "NONE") return;
    currentRoot = rootPath;
    document.getElementById('currentRoot').innerText = "Viewing: " + rootPath;
    const container = document.getElementById('treeRoot');
    
    container.innerHTML = "Loading...";
    container.innerHTML = ''; 

    // 1. ADD THE "SELECT WHOLE DRIVE" HEADER NODE
    const rootNode = document.createElement('div');
    rootNode.className = 'tree-item';
    rootNode.style.marginBottom = "5px";
    rootNode.style.borderBottom = "1px solid #333";
    
    const rootRow = document.createElement('div');
    rootRow.className = 'tree-row';
    rootRow.innerHTML = `<span class="caret">‚ñº</span><span class="icon">üíæ</span> <span style="font-weight:bold; color:var(--neon);">[SELECT ENTIRE DRIVE]</span>`;
    rootRow.onclick = () => selectNode(rootRow, rootPath); // <--- This allows selecting the parent
    
    rootNode.appendChild(rootRow);
    container.appendChild(rootNode);

    // 2. Load Children
    await loadFolder(rootPath, container);
  }

  function refreshTree() { initTree(currentRoot); }

  async function loadFolder(path, container) {
    const res = await api(`/api/fs/list?path=${encodeURIComponent(path)}`);
    if (res.error) {
        container.innerHTML += `<div style="color:red; padding:5px;">Error: ${res.error}</div>`;
        return;
    }
    if (!res.entries || res.entries.length === 0) {
        container.innerHTML += `<div style="color:gray; padding-left:20px;">(Empty)</div>`;
        return;
    }

    res.entries.forEach(entry => {
      const node = document.createElement('div');
      node.style.marginLeft = "15px";
      
      const row = document.createElement('div');
      row.className = 'tree-row';
      row.onclick = (e) => {
        if(!e.target.className.includes('caret')) selectNode(row, entry.path);
      };

      const caret = document.createElement('span');
      caret.className = 'caret';
      if (entry.type === 'dir') {
        caret.innerText = '‚ñ∂';
        caret.onclick = () => toggleFolder(caret, childrenBox, entry.path);
      } else {
        caret.innerText = '‚Ä¢'; caret.style.color = 'gray';
      }

      row.innerHTML = `<span class="icon">${entry.type==='dir'?'üìÅ':'üìÑ'}</span> ${entry.name}`;
      row.prepend(caret);
      node.appendChild(row);

      const childrenBox = document.createElement('div');
      childrenBox.className = 'hidden';
      node.appendChild(childrenBox);

      container.appendChild(node);
    });
  }

  async function toggleFolder(caret, container, path) {
    if (container.classList.contains('hidden')) {
      caret.innerText = '‚ñº';
      container.classList.remove('hidden');
      if (container.innerHTML === '') {
        container.innerHTML = '<div style="padding-left:20px; color:gray;">Loading...</div>';
        await loadFolder(path, container);
      }
    } else {
      caret.innerText = '‚ñ∂';
      container.classList.add('hidden');
    }
  }

  function selectNode(row, path) {
    document.querySelectorAll('.selected').forEach(e => e.classList.remove('selected'));
    row.classList.add('selected');
    selectedPath = path;
  }

  // --- ACTIONS ---
  function addSelection(type) {
    if (!selectedPath) return alert("Select a folder or [ENTIRE DRIVE] first.");
    (type === 'gold' ? goldPaths : targetPaths).add(selectedPath);
    renderLists();
  }

  function renderLists() {
    const draw = (set, id, type) => {
      const el = document.getElementById(id);
      el.innerHTML = '';
      set.forEach(p => {
        el.innerHTML += `<div class="list-item"><span>${p}</span> <span class="remove-x" onclick="removePath('${type}','${p.replace(/\\/g,'\\\\')}')">X</span></div>`;
      });
    };
    draw(goldPaths, 'goldList', 'gold');
    draw(targetPaths, 'targetList', 'target');
  }

  function removePath(t, p) { (t==='gold'?goldPaths:targetPaths).delete(p); renderLists(); }
  function clearList(t) { (t==='gold'?goldPaths:targetPaths).clear(); renderLists(); }

  async function mountNetwork() {
    const res = await api('/api/mount', 'POST', {
      remote_path: document.getElementById('netPath').value,
      username: document.getElementById('netUser').value,
      password: document.getElementById('netPass').value
    });
    alert(res.message || "Done");
    if(currentRoot.includes('mnt')) refreshTree();
  }

  async function startScan() {
    if (goldPaths.size === 0 || targetPaths.size === 0) return alert("Select GOLD and TARGET.");
    document.getElementById('statusBox').innerText = "STARTING...";
    await api('/api/scan', 'POST', { gold_paths: [...goldPaths], target_paths: [...targetPaths] });
    
    const t = setInterval(async () => {
      const s = await api('/api/status');
      document.getElementById('statusBox').innerText = `${s.status} | Files: ${s.file_count}`;
      if (s.status === 'COMPLETE') { clearInterval(t); document.getElementById('btnAnalyze').disabled = false; }
    }, 1000);
  }

  async function analyze() {
    const res = await api('/api/analyze');
    alert(`Duplicates: ${res.count} (${res.size_gb} GB)`);
    if(res.count > 0) document.getElementById('btnClean').disabled = false;
  }

  async function clean() {
    if(!confirm("DELETE TARGET FILES?")) return;
    const res = await api('/api/clean', 'POST', {});
    alert(`Deleted: ${res.deleted}`);
  }

  // Init
  loadDrives();
</script>
</body>
</html>
