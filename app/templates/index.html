<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Silicon | Sentry Command</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-color: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #334155;
            padding-bottom: 20px;
        }

        .logo { font-size: 1.5rem; font-weight: bold; letter-spacing: 1px; }
        .status-pill {
            background: var(--panel-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #334155;
        }

        /* GRID LAYOUT */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: var(--panel-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 { margin-top: 0; color: var(--text-secondary); font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.05em; }

        /* DRIVE LIST */
        .drive-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #334155;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--text-secondary);
        }
        
        .drive-info div { margin-bottom: 4px; }
        .drive-name { font-weight: bold; color: #fff; }
        .drive-meta { font-size: 0.85rem; color: var(--text-secondary); }

        .health-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: bold;
        }
        .health-pass { background: #064e3b; color: #6ee7b7; }
        .health-fail { background: #450a0a; color: #fca5a5; }
        .health-warn { background: #451a03; color: #fcd34d; }

        .btn {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-mount { background: var(--accent-blue); color: white; }
        .btn-unmount { background: #475569; color: var(--text-secondary); }
        .btn-scan { background: var(--accent-green); color: white; width: 100%; font-size: 1.1rem; padding: 15px; margin-top: 20px; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* FILE PICKER */
        .path-list {
            max-height: 300px;
            overflow-y: auto;
            background: #0f172a;
            border-radius: 8px;
            padding: 10px;
        }
        .path-item {
            padding: 8px;
            border-bottom: 1px solid #1e293b;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .path-item:hover { background: #1e293b; }
        .selected { background: #1e3a8a !important; }

        /* PRIVACY TOGGLE */
        .toggle-row {
            display: flex;
            align-items: center;
            margin-top: 20px;
            background: #334155;
            padding: 15px;
            border-radius: 8px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            margin-right: 15px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-green); }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo">SOVEREIGN SILICON <span style="color:var(--accent-green)">// SENTRY</span></div>
            <div class="status-pill" id="system-status">System Status: IDLE</div>
        </header>

        <div class="grid">
            
            <div class="panel">
                <h2>Connected Drives</h2>
                <div id="drive-list">
                    <div style="text-align:center; padding:20px; color:var(--text-secondary)">Scanning for hardware...</div>
                </div>
                <button class="btn" style="background:#334155; color:#fff; width:100%; margin-top:10px" onclick="fetchDrives()">‚Üª Refresh Hardware</button>
            </div>

            <div class="panel">
                <h2>Mission Configuration</h2>
                
                <div style="margin-bottom:20px;">
                    <label style="color:var(--accent-yellow); font-weight:bold; display:block; margin-bottom:10px;">üìÇ 1. Select MASTER (Gold) Folder</label>
                    <div class="path-list" id="gold-browser"></div>
                </div>

                <div>
                    <label style="color:var(--accent-blue); font-weight:bold; display:block; margin-bottom:10px;">üéØ 2. Select TARGET (Client) Drive</label>
                    <div class="path-list" id="target-browser"></div>
                </div>

                <div class="toggle-row">
                    <label class="toggle-switch">
                        <input type="checkbox" id="privacy-toggle">
                        <span class="slider"></span>
                    </label>
                    <div>
                        <div style="font-weight:bold">AI Privacy Scan</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary)">Detect & Quarantine Sensitive Images</div>
                    </div>
                </div>

                <button class="btn btn-scan" onclick="startMission()">INITIATE SCAN</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let selectedGold = [];
        let selectedTarget = [];

        // --- 1. DRIVE MANAGER ---
        async function fetchDrives() {
            try {
                const res = await fetch('/api/drives');
                const drives = await res.json();
                const container = document.getElementById('drive-list');
                container.innerHTML = '';

                drives.forEach(drive => {
                    // Health Badge Logic
                    let healthClass = 'health-warn';
                    let healthText = drive.health;
                    if(drive.health.includes('PASSED')) healthClass = 'health-pass';
                    if(drive.health.includes('FAILED')) healthClass = 'health-fail';

                    // Mount Button Logic
                    const actionBtn = drive.is_mounted 
                        ? `<button class="btn btn-unmount" onclick="toggleMount('${drive.device}', false)">UNMOUNT</button>`
                        : `<button class="btn btn-mount" onclick="toggleMount('${drive.device}', true)">MOUNT</button>`;

                    const html = `
                        <div class="drive-item" style="border-left-color: ${drive.is_mounted ? 'var(--accent-green)' : 'var(--text-secondary)'}">
                            <div class="drive-info">
                                <div class="drive-name">
                                    ${drive.name || 'Unknown Drive'} 
                                    <span class="health-badge ${healthClass}">${healthText}</span>
                                </div>
                                <div class="drive-meta">${drive.size} ‚Ä¢ ${drive.device} ‚Ä¢ ${drive.mountpoint || 'Not Mounted'}</div>
                            </div>
                            <div>${actionBtn}</div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
                
                // Refresh file browsers too
                loadPath('/media', 'target-browser', false);
                loadPath('/host_fs/home/greg', 'gold-browser', true); 

            } catch (e) {
                console.error("Drive Error:", e);
            }
        }

        async function toggleMount(devicePath, mount) {
            const endpoint = mount ? '/api/drives/mount' : '/api/drives/unmount';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ device_path: devicePath })
            });
            const data = await res.json();
            if(data.error) alert("Error: " + data.error);
            
            // Wait 1s for OS to settle then refresh
            setTimeout(fetchDrives, 1000);
        }


        // --- 2. FILE BROWSER ---
        async function loadPath(path, elementId, isGold) {
            const container = document.getElementById(elementId);
            container.innerHTML = '<div style="padding:10px">Loading...</div>';
            
            try {
                // Adjust path for Host FS vs Container FS
                const apiPath = `/api/fs/list?path=${encodeURIComponent(path)}`;
                const res = await fetch(apiPath);
                const data = await res.json();

                container.innerHTML = '';
                
                // Back Button
                if (path !== '/' && path !== '/media') {
                    const parent = path.substring(0, path.lastIndexOf('/')) || '/';
                    container.insertAdjacentHTML('beforeend', 
                        `<div class="path-item" onclick="loadPath('${parent}', '${elementId}', ${isGold})">üìÅ .. (Up)</div>`
                    );
                }

                if (data.entries) {
                    data.entries.forEach(entry => {
                        const isDir = entry.type === 'dir';
                        const icon = isDir ? 'üìÅ' : 'üìÑ';
                        const clickAction = isDir 
                            ? `onclick="loadPath('${entry.path}', '${elementId}', ${isGold})"` 
                            : '';
                        
                        // Selection Logic
                        const isSelected = isGold 
                            ? selectedGold.includes(entry.path)
                            : selectedTarget.includes(entry.path);

                        const html = `
                            <div class="path-item ${isSelected ? 'selected' : ''}" ${clickAction}>
                                <span style="margin-right:10px">${icon}</span>
                                <span style="flex-grow:1">${entry.name}</span>
                                ${isDir ? `<button class="btn" style="font-size:0.7rem; padding:2px 8px;" onclick="selectFolder(event, '${entry.path}', ${isGold}, '${elementId}')">SELECT</button>` : ''}
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', html);
                    });
                }
            } catch (e) {
                container.innerHTML = `<div style="color:red">Access Denied or Empty</div>`;
            }
        }

        function selectFolder(e, path, isGold, elementId) {
            e.stopPropagation(); // Don't trigger navigation
            if (isGold) {
                selectedGold = [path]; // Single select for Gold for now
                document.getElementById('gold-browser').style.borderColor = 'var(--accent-yellow)';
            } else {
                selectedTarget = [path];
                document.getElementById('target-browser').style.borderColor = 'var(--accent-blue)';
            }
            // Visual feedback
            alert((isGold ? "Gold" : "Target") + " set to: " + path);
        }

        // --- 3. MISSION CONTROL ---
        async function startMission() {
            if (selectedGold.length === 0 || selectedTarget.length === 0) {
                alert("‚ö†Ô∏è Please select both a MASTER folder and a TARGET drive/folder.");
                return;
            }

            const payload = {
                gold_paths: selectedGold,
                target_paths: selectedTarget,
                enable_privacy: document.getElementById('privacy-toggle').checked
            };

            const res = await fetch('/api/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            alert("üöÄ Mission Started! ID: " + data.mission_id);
            // In a full app, we would redirect to a "Live Status" page here
        }

        // Auto-load on start
        window.onload = fetchDrives;
    </script>
</body>
</html>
