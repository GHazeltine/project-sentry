<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sentry Command | V2 Stable</title>
    <style>
        body { background: #111; color: #eee; font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        h2 { border-bottom: 1px solid #444; color: #4caf50; }
        .box { background: #222; padding: 15px; margin-bottom: 20px; border: 1px solid #333; }
        
        /* HARDWARE STRIP */
        .drive-row { background: #000; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 5px 15px; cursor: pointer; border: none; font-weight: bold; }
        .btn-blue { background: #2196f3; color: white; }
        .btn-green { background: #4caf50; color: white; }
        .btn-red { background: #f44336; color: white; }

        /* BROWSER */
        .browser { height: 200px; overflow-y: scroll; background: #000; border: 1px solid #444; padding: 5px; }
        .item { padding: 5px; cursor: pointer; border-bottom: 1px solid #222; }
        .item:hover { background: #333; }
        .selected { background: #004d40; color: #fff; }
        
        .status-bar { padding: 10px; background: #333; text-align: center; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="status-bar" id="status-display">SYSTEM READY</div>

    <h2>1. HARDWARE CONTROL</h2>
    <div class="box" id="drive-list">
        <div>Scanning Hardware...</div>
    </div>

    <h2>2. SELECT GOLD SOURCE (MASTER)</h2>
    <div class="box">
        <div id="gold-path-display" style="color:#aaa; margin-bottom:5px">Current: None</div>
        <div class="browser" id="gold-browser"></div>
    </div>

    <h2>3. SELECT TARGET (CLIENT)</h2>
    <div class="box">
        <div id="target-path-display" style="color:#aaa; margin-bottom:5px">Current: None</div>
        <div class="browser" id="target-browser"></div>
        <button class="btn btn-blue" style="width:100%; margin-top:10px" onclick="selectCurrentTargetRoot()">SELECT CURRENT FOLDER AS ROOT</button>
    </div>

    <h2>4. EXECUTE</h2>
    <div class="box">
        <label><input type="checkbox" id="privacy-check"> Enable Privacy AI Scan</label>
        <br><br>
        <button class="btn btn-red" style="width:100%; padding: 15px; font-size:1.2em" onclick="launchMission()">INITIATE SCAN</button>
    </div>

    <script>
        let currentGoldPath = '/host_fs/home/greg';
        let currentTargetPath = '/media';
        let selectedGold = null;
        let selectedTarget = null;

        // --- HARDWARE ---
        async function loadDrives() {
            const res = await fetch('/api/drives');
            const drives = await res.json();
            const container = document.getElementById('drive-list');
            container.innerHTML = '';
            
            if(drives.length === 0) container.innerHTML = 'No USB drives found.';

            drives.forEach(d => {
                // Only show real disks/partitions
                if(d.device.startsWith('/dev/sd')) {
                    const btn = d.is_mounted 
                        ? `<button class="btn btn-green" onclick="mountDrive('${d.device}', false)">MOUNTED (CLICK TO UNMOUNT)</button>`
                        : `<button class="btn btn-blue" onclick="mountDrive('${d.device}', true)">MOUNT DRIVE</button>`;
                    
                    container.innerHTML += `
                        <div class="drive-row">
                            <span><strong>${d.device}</strong> (${d.size}) - ${d.health}</span>
                            ${btn}
                        </div>
                    `;
                }
            });
        }

        async function mountDrive(dev, doMount) {
            const ep = doMount ? '/api/drives/mount' : '/api/drives/unmount';
            await fetch(ep, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({device_path: dev})
            });
            setTimeout(() => { loadDrives(); loadBrowser('target', '/media'); }, 1000);
        }

        // --- BROWSERS ---
        async function loadBrowser(type, path) {
            const container = document.getElementById(type + '-browser');
            container.innerHTML = 'Loading...';
            try {
                const res = await fetch(`/api/fs/list?path=${encodeURIComponent(path)}`);
                const data = await res.json();
                
                if(data.error) { container.innerHTML = 'Error: ' + data.error; return; }
                container.innerHTML = '';

                // Up Dir
                if(path !== '/' && path !== '/host_fs') {
                    const parent = path.substring(0, path.lastIndexOf('/')) || '/';
                    container.innerHTML += `<div class="item" onclick="loadBrowser('${type}', '${parent}')">.. (UP)</div>`;
                }

                // Update Globals
                if(type === 'gold') currentGoldPath = path;
                if(type === 'target') currentTargetPath = path;

                data.entries.forEach(e => {
                    const style = (type==='gold' && selectedGold===e.path) || (type==='target' && selectedTarget===e.path) ? 'selected' : '';
                    const action = e.type === 'dir' 
                        ? `onclick="loadBrowser('${type}', '${e.path}')"` 
                        : `onclick="selectFile('${type}', '${e.path}')"`;
                    
                    // Add SELECT button for Gold folders
                    let extra = '';
                    if(type === 'gold' && e.type === 'dir') {
                        extra = `<button class="btn btn-blue" style="float:right; font-size:0.7em" onclick="event.stopPropagation(); selectPath('gold', '${e.path}')">SELECT</button>`;
                    }

                    container.innerHTML += `<div class="item ${style}" ${action}>${e.type==='dir'?'üìÅ':'üìÑ'} ${e.name} ${extra}</div>`;
                });
            } catch(e) { container.innerHTML = 'Access Denied'; }
        }

        function selectPath(type, path) {
            if(type === 'gold') {
                selectedGold = path;
                document.getElementById('gold-path-display').innerText = "SELECTED: " + path;
            }
        }
        
        function selectCurrentTargetRoot() {
            selectedTarget = currentTargetPath; // Selects the folder you are currently VIEWING
            document.getElementById('target-path-display').innerText = "SELECTED ROOT: " + currentTargetPath;
        }

        // --- LAUNCH ---
        async function launchMission() {
            if(!selectedGold || !selectedTarget) { alert("Select both paths!"); return; }
            
            const res = await fetch('/api/scan', {
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    gold_paths: [selectedGold],
                    target_paths: [selectedTarget],
                    enable_privacy: document.getElementById('privacy-check').checked
                })
            });
            const data = await res.json();
            document.getElementById('status-display').innerText = "SCANNING... ID: " + data.mission_id;
        }

        // INIT
        loadDrives();
        loadBrowser('gold', '/host_fs/home/greg');
        loadBrowser('target', '/media');
        
        // Poll Status
        setInterval(async () => {
            const res = await fetch('/api/status');
            const d = await res.json();
            if(d.status !== 'IDLE') {
                document.getElementById('status-display').innerText = `STATUS: ${d.status} | FILES: ${d.file_count}`;
            }
        }, 2000);

    </script>
</body>
</html>
